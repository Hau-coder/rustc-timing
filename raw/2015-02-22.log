commit 2b01a37ec38db9301239f0c0abcf3c695055b0ff
Merge: 522d09d 5513040
Author: bors <bors@rust-lang.org>
Date:   Sat Feb 21 09:20:48 2015 +0000

    Auto merge of #21959 - dhuseby:bitrig-support, r=brson
    
    This patch adds the necessary pieces to support rust on Bitrig https://bitrig.org

diff --cc src/libstd/sys/unix/thread.rs
index c90ba76,ae9261d..c42d6d0
--- a/src/libstd/sys/unix/thread.rs
+++ b/src/libstd/sys/unix/thread.rs
@@@ -190,9 -194,25 +195,25 @@@ pub mod guard 
  
          stackaddr as uint + guardsize as uint
      }
+ 
+     #[cfg(target_os = "bitrig")]
+     pub unsafe fn current() -> uint {
+       let mut current_stack: stack_t = mem::zeroed();
+       if pthread_stackseg_np(pthread_self(), &mut current_stack) != 0 {
+         panic!("failed to get current stack: pthread_stackseg_np")
+       }
+ 
+       if pthread_main_np() == 1 {
+         // main thread
+         current_stack.ss_sp as uint - current_stack.ss_size as uint + 3 * PAGE_SIZE as uint
+       } else {
+         // new thread
+         current_stack.ss_sp as uint - current_stack.ss_size as uint
+       }
+     }
  }
  
 -pub unsafe fn create(stack: uint, p: Thunk) -> rust_thread {
 +pub unsafe fn create(stack: uint, p: Thunk) -> io::Result<rust_thread> {
      let mut native: libc::pthread_t = mem::zeroed();
      let mut attr: libc::pthread_attr_t = mem::zeroed();
      assert_eq!(pthread_attr_init(&mut attr), 0);
cfg: version 1.0.0-dev (2b01a37ec 2015-02-21) (built 2015-02-22)
cfg: build triple x86_64-unknown-linux-gnu
cfg: host triples x86_64-unknown-linux-gnu
cfg: target triples x86_64-unknown-linux-gnu
cfg: enabling more debugging (CFG_ENABLE_DEBUG)
cfg: host for x86_64-unknown-linux-gnu is x86_64
cfg: os for x86_64-unknown-linux-gnu is unknown-linux-gnu
cfg: good valgrind for x86_64-unknown-linux-gnu is 1
cfg: enabling valgrind run-pass tests (CFG_ENABLE_VALGRIND_RPASS)
cfg: valgrind-rpass command set to "/usr/bin/valgrind" --error-exitcode=100 --soname-synonyms=somalloc=NONE --quiet --suppressions=/home/ncameron/rust3/src/etc/x86.supp  --tool=memcheck --leak-check=full
cfg: no xelatex found, disabling LaTeX docs
cfg: no pandoc found, omitting PDF and EPUB docs
cfg: reconfiguring
/home/ncameron/rust3/configure 
configure: looking for configure programs
configure: found program cmp
configure: found program mkdir
configure: found program printf
configure: found program cut
configure: found program head
configure: found program grep
configure: found program xargs
configure: found program cp
configure: found program find
configure: found program uname
configure: found program date
configure: found program tr
configure: found program sed
configure: found program file
configure: found program make
configure: inspecting environment
configure: recreating config.tmp
configure: 
configure: processing /home/ncameron/rust3/configure args
configure: 
configure: CFG_LOCALSTATEDIR    := /var/lib 
configure: CFG_SYSCONFDIR       := /etc 
configure: CFG_DATADIR          := /usr/local/share 
configure: CFG_INFODIR          := /usr/local/share/info 
configure: CFG_LLVM_ROOT        :=  
configure: CFG_JEMALLOC_ROOT    :=  
configure: CFG_BUILD            := x86_64-unknown-linux-gnu 
configure: CFG_ANDROID_CROSS_PATH := /opt/ndk_standalone 
configure: CFG_BUILD            := x86_64-unknown-linux-gnu 
configure: CFG_LIBDIR           := /usr/local/lib 
configure: 
configure: validating /home/ncameron/rust3/configure args
configure: 
configure: CFG_RELEASE_CHANNEL  := dev 
configure: CFG_BOOTSTRAP_KEY    := 21:53:02 
configure: 
configure: looking for build programs
configure: 
configure: CFG_CURLORWGET       := /usr/bin/curl (7.35.0)
configure: CFG_PYTHON           := /usr/bin/python2.7 
configure: CFG_GIT              := /usr/bin/git (1.9.1)
configure: CFG_CLANG            :=  
configure: CFG_CCACHE           := /usr/bin/ccache (3.1.9)
configure: CFG_GCC              := /usr/bin/gcc (4.8.2-19ubuntu1))
configure: CFG_LD               := /usr/bin/ld (2.24)
configure: CFG_VALGRIND         := /usr/bin/valgrind (3.10.0.SVN)
configure: CFG_PERF             := /usr/bin/perf (3.13.11-ckt13)
configure: CFG_ISCC             :=  
configure: CFG_JAVAC            := /usr/bin/javac 
configure: CFG_ANTLR4           :=  
configure: CFG_GRUN             :=  
configure: CFG_FLEX             :=  
configure: CFG_BISON            :=  
configure: CFG_PANDOC           :=  
configure: CFG_XELATEX          :=  
configure: CFG_GDB              := /usr/bin/gdb (7.7.1-0ubuntu5~14.04.2))
configure: CFG_LLDB             :=  
configure: CFG_GDB_VERSION      := GNU gdb (Ubuntu 7.7.1-0ubuntu5~14.0 ...
configure: 
configure: looking for target specific programs
configure: 
configure: CFG_ADB              :=  
configure: skipping compiler inference steps; using provided CC=clang
configure: 
configure: note, user-provided CC looks like clang; CC=clang.
configure: 
configure: CFG_USING_CLANG      := 1 
configure: CFG_CC               := clang 
configure: CFG_CXX              := clang++ 
configure: CFG_PERF_WITH_LOGFD  := 1 
configure: 
configure: making directories
configure: 
configure: mkdir -p doc
configure: mkdir -p doc/std
configure: mkdir -p doc/extra
configure: 
configure: configuring submodules
configure: 
configure: git: submodule sync
Synchronizing submodule url for 'src/compiler-rt'
Synchronizing submodule url for 'src/jemalloc'
Synchronizing submodule url for 'src/llvm'
Synchronizing submodule url for 'src/rt/hoedown'
Synchronizing submodule url for 'src/rust-installer'
configure: git: submodule init
configure: git: submodule update
configure: git: submodule foreach sync
Entering 'src/compiler-rt'
Entering 'src/jemalloc'
Entering 'src/llvm'
Entering 'src/rt/hoedown'
Entering 'src/rust-installer'
configure: git: submodule foreach update
configure: git: submodule status
 58ab642c30d9f97735d5745b5d01781ee199c6ae src/compiler-rt (remotes/origin/rust-2015-01-08-do-not-delete)
 b001609960ca33047e5cbc5a231c1e24b6041d4b src/jemalloc (3.6.0-156-gb001609)
 4891e6382e3e8aa89d530aa18427836428c47157 src/llvm (4891e63)
 238c4d57cce10d33b05cf52a91fc62a09f31ffbb src/rt/hoedown (2.0.0-63-g238c4d5)
 60fd8abfcae50629a3fc664bd809238fed039617 src/rust-installer (remotes/origin/next-3-g60fd8ab)
-aed73472416064642911af790b25d57c9390b6c7 src/rust-installer/test/rust-installer-v1
-e577c97b494be2815b215e3042207d6d4b7c5516 src/rust-installer/test/rust-installer-v2
configure: git: submodule clobber
Entering 'src/compiler-rt'
Entering 'src/jemalloc'
Removing VERSION
Entering 'src/llvm'
Entering 'src/rt/hoedown'
Entering 'src/rust-installer'
Entering 'src/compiler-rt'
Entering 'src/jemalloc'
Entering 'src/llvm'
Entering 'src/rt/hoedown'
Entering 'src/rust-installer'
configure: 
configure: looking at LLVM
configure: 
configure: configuring LLVM for x86_64-unknown-linux-gnu
configure: configuring LLVM with:
configure: --enable-targets=x86,x86_64,arm,aarch64,mips,powerpc --enable-optimized --enable-assertions --disable-docs --enable-bindings=none --disable-terminfo --disable-zlib --disable-libffi --enable-libcpp --build=x86_64-unknown-linux-gnu                         --host=x86_64-unknown-linux-gnu --target=x86_64-unknown-linux-gnu --with-python=/usr/bin/python2.7
checking for x86_64-unknown-linux-gnu-clang... clang -Qunused-arguments
checking for C compiler default output file name... configure: error: LLVM configure failed
