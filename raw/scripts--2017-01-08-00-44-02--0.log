commit 5219dad855e153de2e09f31835d83134d505da3a
Merge: 0576869 9ced901
Author: bors <bors@rust-lang.org>
Date:   Sun Jan 8 06:19:14 2017 +0000

    Auto merge of #38883 - alexcrichton:android-flaky, r=brson
    
    compiletest: Fix flaky Android gdb test runs
    
    Local testing showed that I was able to reproduce an error where debuginfo tests
    on Android would fail with "connection reset by peer". Further investigation
    turned out that the gdb tests are android with bit of process management:
    
    * First an `adb forward` command is run to ensure that the host's port 5039 is
      the same as the emulator's.
    * Next an `adb shell` command is run to execute the `gdbserver` executable
      inside the emulator. This gdb server will attach to port 5039 and listen for
      remote gdb debugging sessions.
    * Finally, we run `gdb` on the host (not in the emulator) and then connect to
      this gdb server to send it commands.
    
    The problem was happening when the host's gdb was failing to connect to the
    remote gdbserver running inside the emulator. The previous test for this was
    that after `adb shell` executed we'd sleep for a second and then attempt to make
    a TCP connection to port 5039. If successful we'd run gdb and on failure we'd
    sleep again.
    
    It turns out, however, that as soon as we've executed `adb forward` all TCP
    connections to 5039 will succeed. This means that we would only ever sleep for
    at most one second, and if this wasn't enough time we'd just fail later because
    we would assume that gdbserver had started but it may not have done so yet.
    
    This commit fixes these issues by removing the TCP connection to test if
    gdbserver is ready to go. Instead we read the stdout of the process and wait for
    it to print that it's listening at which point we start running gdb. I've found
    that locally at least I was unable to reproduce the failure after these changes.
    
    Closes #38710
rustc 1.15.0-nightly (daf8c1dfc 2016-12-05)
-rwxr-xr-x 1 root root 9432 Dec  6 15:39 /usr/local/bin/rustc
rustc: ./scripts
done
